<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>STN25XR | √ñxnehaga | Huskvarna</title>

  <!-- ArcGIS API ‚Äì RIKTIGA TAGGAR -->
  <link rel="stylesheet" href="https://js.arcgis.com/4.30/esri/themes/light/main.css" />
  <script src="https://js.arcgis.com/4.30/"></script>

  <style>
    /* ===== Global ===== */
    html, body { margin:0; padding:0; height:100%; width:100%; overflow:hidden; font-family:"IBM Plex Sans", "Helvetica Neue", Arial, sans-serif; background:#eef1f4; }

    /* ===== Header ===== */
    #header {
      height: 70px; background:#f8fafc; border-bottom:1px solid #d7dee6;
      padding:0 20px; display:flex; justify-content:space-between; align-items:center; box-sizing:border-box;
    }
    #header-info { text-align:right; font-size:14px; line-height:1.25; }
    #clock { color:#666; }

    /* ===== Sidebar ===== */
    #sidebar {
      position:fixed; top:70px; left:0; width:260px; height:calc(100% - 70px);
      background:#1f232b; color:#fff; padding:20px; box-sizing:border-box; overflow-y:auto; z-index:10;
    }
    #sidebar h2 {
      margin:0 0 12px 0; font-size:16px; color:#ddd; border-bottom:1px solid #444; padding-bottom:8px;
    }
    .switch-row { display:flex; justify-content:space-between; align-items:center; margin:14px 0; }
    .switch-label { font-size:14px; user-select:none; }

    /* ===== Slide switch ===== */
    .switch { position:relative; width:44px; height:24px; }
    .switch input { opacity:0; width:0; height:0; }
    .slider { position:absolute; inset:0; background:#555; border-radius:24px; cursor:pointer; transition:.2s; }
    .slider:before { content:""; position:absolute; left:3px; top:3px; width:18px; height:18px; background:#fff; border-radius:50%; transition:.2s; box-shadow:0 1px 2px rgba(0,0,0,.4); }
    .switch input:checked + .slider { background:#2d6cdf; }
    .switch input:checked + .slider:before { transform:translateX(20px); }

    /* ===== Right Panel ===== */
    #info-panel {
      position:fixed; top:70px; right:0; width:320px; height:calc(100% - 70px);
      background:#f7f9fb; border-left:1px solid #d7dee6; padding:16px; box-sizing:border-box; overflow-y:auto; z-index:10;
    }
    #info-panel h2 { margin:0 0 10px 0; font-size:16px; color:#1f2937; }
    .panel-section { background:#fff; border:1px solid #e3e7ee; border-radius:10px; padding:12px; margin-bottom:12px; box-shadow:0 1px 2px rgba(15,23,42,.05); }
    .panel-title { font-size:13px; letter-spacing:.02em; text-transform:uppercase; color:#64748b; margin:0 0 8px 0; }
    #attrHint { color:#475569; font-size:13px; }
    #attrTable { width:100%; border-collapse:collapse; font-size:13px; }
    #attrTable td { padding:5px 4px; border-bottom:1px solid #eef2f7; vertical-align:top; }
    #attrTable td:first-child { font-weight:600; color:#0f172a; width:42%; }

    .field-row { display:flex; gap:8px; align-items:center; margin-bottom:8px; }
    select, button {
      font-family:inherit; font-size:13px; padding:6px 8px; border-radius:8px; border:1px solid #cbd5e1; background:#fff;
    }
    button { background:#1f6feb; color:#fff; border-color:#1f6feb; cursor:pointer; }
    button:disabled { background:#9bb3da; border-color:#9bb3da; cursor:not-allowed; }
    #uniqueList { list-style:none; padding:0; margin:8px 0 0 0; font-size:13px; }
    #uniqueList li { padding:4px 0; border-bottom:1px dashed #e2e8f0; color:#0f172a; }

    /* ===== Map ===== */
    #sceneView {
      position:absolute; top:70px; left:260px; right:320px; height:calc(100% - 70px); z-index:1;
    }

    @media (max-width: 900px) {
      #sidebar { width:200px; }
      #info-panel { width:260px; }
      #sceneView { left:200px; right:260px; }
    }
    @media (max-width: 720px) {
      #sidebar { width:180px; }
      #info-panel { display:none; }
      #sceneView { left:180px; right:0; }
    }
  </style>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;600&display=swap" rel="stylesheet" />
</head>
<body>

  <!-- HEADER -->
  <div id="header">
    <div id="header-title">STN25XR | √ñxnehaga | Huskvarna</div>
    <div id="header-info">
      <div>√ñxnehaga i Huskvarna ‚Äì ca 3400 inv√•nare</div>
      <div id="wx-summary">V√§der: ‚Ä¶</div>
      <div id="wx-precip">Nederb√∂rd (n√§sta 2 h): ‚Ä¶</div>
      <div id="wx-snow">Sn√∂risk (n√§sta 2 h): ‚Ä¶</div>
      <div id="temp">Temperatur: ‚Ä¶</div>
      <div id="clock">00:00:00</div>
    </div>
  </div>

  <!-- SIDEBAR -->
  <aside id="sidebar" aria-label="Sidomeny">
    <h2>Meny</h2>

    <div class="switch-row">
      <span class="switch-label">Visa byggnader</span>
      <label class="switch" aria-label="Visa byggnader">
        <input id="swBuildings" type="checkbox" checked />
        <span class="slider"></span>
      </label>
    </div>

    <div class="switch-row">
      <span class="switch-label">Visa Oxnehaga</span>
      <label class="switch" aria-label="Visa Oxnehaga">
        <input id="swOx" type="checkbox" checked />
        <span class="slider"></span>
      </label>
    </div>

    <div class="switch-row">
      <span class="switch-label">Visa bussh√•llplatser</span>
      <label class="switch" aria-label="Visa bussh√•llplatser">
        <input id="swBus" type="checkbox" checked />
        <span class="slider"></span>
      </label>
    </div>

    <div class="switch-row">
      <span class="switch-label">Visa kommunal mark</span>
      <label class="switch" aria-label="Visa kommunal mark">
        <input id="swMark" type="checkbox" checked />
        <span class="slider"></span>
      </label>
    </div>

    <div class="switch-row">
      <span class="switch-label">Visa vatten</span>
      <label class="switch" aria-label="Visa vatten">
        <input id="swWater" type="checkbox" checked />
        <span class="slider"></span>
      </label>
    </div>
  </aside>

  <!-- INFO PANEL -->
  <aside id="info-panel" aria-label="Info panel">
    <h2>Information</h2>

    <div class="panel-section">
      <div class="panel-title">Valt objekt</div>
      <div id="attrHint">Klicka p√• ett objekt i kartan</div>
      <table id="attrTable"></table>
    </div>

    <div class="panel-section">
      <div class="panel-title">Avg√•ngar (bussh√•llplats)</div>
      <div id="depHint">Klicka p√• en bussh√•llplats</div>
      <div id="depMeta" style="font-size:12px;color:#64748b;margin-top:6px;"></div>
      <div style="margin-top:6px;">
        <a id="depLink" href="https://www.jlt.se/tidtabeller/" target="_blank" rel="noopener"
           style="font-size:12px;color:#2563eb;text-decoration:none;">√ñppna tidtabell online</a>
      </div>
      <ul id="depList"></ul>
    </div>

    <div class="panel-section">
      <div class="panel-title">Unika attribut</div>
      <div class="field-row">
        <select id="uniqueLayer"></select>
        <select id="uniqueField"></select>
      </div>
      <div class="field-row">
        <button id="loadUnique" type="button">H√§mta</button>
        <span id="uniqueMeta" style="font-size:12px;color:#64748b;"></span>
      </div>
      <ul id="uniqueList"></ul>
    </div>
  </aside>

  <!-- MAP -->
  <div id="sceneView" role="main" aria-label="3D‚Äëkarta"></div>

  <!-- CLOCK -->
  <script>
    function updateClock() {
      const el = document.getElementById("clock");
      if (el) el.textContent = new Date().toLocaleTimeString("sv-SE");
    }
    setInterval(updateClock, 1000); updateClock();
  </script>

  <!-- WEATHER -->
  <script>
    function describeWeather(code) {
      const map = {
        0:"‚òÄÔ∏è Klart",1:"üå§Ô∏è Mest klart",2:"‚õÖ V√§xlande molnighet",3:"‚òÅÔ∏è Mulet",
        45:"üå´Ô∏è Dimma",48:"üå´Ô∏è Dimfrost",
        51:"üåßÔ∏è L√§tt duggregn",53:"üåßÔ∏è M√•ttligt duggregn",55:"üåßÔ∏è Kraftigt duggregn",
        61:"üåßÔ∏è L√§tt regn",63:"üåßÔ∏è Regn",65:"üåßÔ∏è Kraftigt regn",
        66:"üåßÔ∏è Underkylt regn",67:"üåßÔ∏è Kraftigt underkylt regn",
        71:"‚ùÑÔ∏è L√§tt sn√∂fall",73:"‚ùÑÔ∏è Sn√∂fall",75:"‚ùÑÔ∏è Kraftigt sn√∂fall",
        77:"‚ùÑÔ∏è Sn√∂korn",80:"üåßÔ∏è L√§tta regnskurar",81:"üåßÔ∏è Regnskurar",82:"üåßÔ∏è Kraftiga regnskurar",
        85:"‚ùÑÔ∏è Sn√∂byar",86:"‚ùÑÔ∏è Kraftiga sn√∂byar",
        95:"‚õàÔ∏è √Öska",96:"‚õàÔ∏è √Öska + hagel",99:"‚õàÔ∏è Kraftig √•ska + hagel"
      };
      return map[code] || "V√§xlande";
    }

    async function updateWeather() {
      const sum  = document.getElementById("wx-summary");
      const pr   = document.getElementById("wx-precip");
      const snow = document.getElementById("wx-snow");
      const temp = document.getElementById("temp");

      try {
        const url = "https://api.open-meteo.com/v1/forecast"
          + "?latitude=57.796&longitude=14.200"
          + "&current=temperature_2m,weather_code"
          + "&hourly=precipitation_probability,snowfall"
          + "&timezone=auto";

        const res = await fetch(url, { cache: "no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();

        const t = data?.current?.temperature_2m;
        const code = data?.current?.weather_code;
        const p = data?.hourly?.precipitation_probability || [];
        const s = data?.hourly?.snowfall || [];

        const wx = describeWeather(code);
        const maxP = p.length ? Math.max(p[0] ?? 0, p[1] ?? 0) : null;
        const snowSum = s.length ? (Number(s[0] || 0) + Number(s[1] || 0)) : 0;

        sum.textContent  = `V√§der: ${wx}`;
        pr.textContent   = `Nederb√∂rd (n√§sta 2 h): ${maxP !== null ? maxP + " %" : "N/A"}`;
        snow.textContent = `Sn√∂risk (n√§sta 2 h): ${snowSum > 0 ? "Ja (" + snowSum.toFixed(1) + " mm)" : "Nej"}`;
        temp.textContent = (typeof t === "number") ? `Temperatur: ${t}¬∞C` : "Temperatur: N/A";
      } catch (e) {
        sum.textContent  = "V√§der: N/A";
        pr.textContent   = "Nederb√∂rd (n√§sta 2 h): N/A";
        snow.textContent = "Sn√∂risk (n√§sta 2 h): N/A";
        temp.textContent = "Temperatur: N/A";
        console.warn("Weather error:", e);
      }
    }
    updateWeather();
    setInterval(updateWeather, 300000);
  </script>

  <!-- ARCGIS (3D) -->
  <script>
    // Extra koll om ArcGIS‚Äëscriptet inte laddades
    if (typeof window.require !== "function") {
      document.body.insertAdjacentHTML("beforeend",
        "<div style='position:absolute;top:90px;left:270px;font:16px Arial;color:#c00;background:#fff;padding:8px;border:1px solid #c00'>ArcGIS‚Äëscriptet laddades inte. √ñppna via Live Server eller GitHub Pages.</div>");
    }
  </script>

  <script>
    require([
      "esri/Map",
      "esri/views/SceneView",
      "esri/layers/SceneLayer",
      "esri/layers/GeoJSONLayer"
    ], function (Map, SceneView, SceneLayer, GeoJSONLayer) {

      const RESROBOT_KEY = "a1ba6c34-9ea5-4b8f-907e-d4c18a3f58ec"; // Trafiklab ResRobot v2.1 API-nyckel

      const map = new Map({ basemap: "satellite", ground: "world-elevation" });

      const view = new SceneView({
        container: "sceneView",
        map,
        camera: { position: { latitude: 57.796, longitude: 14.200, z: 1800 }, tilt: 45 }
      });

      view.highlightOptions = {
        color: "#00E5FF",
        haloOpacity: 0.8,
        fillOpacity: 0.25
      };

      // 3D‚Äëbyggnader (globalt)
      const buildings = new SceneLayer({
        portalItem: { id: "c444b24b184c4523a5dc96248bfea4e1" },
        visible: true,
        popupEnabled: false
      });
      map.add(buildings);

      // Oxnehaga (din GeoJSON)
      const ox = new GeoJSONLayer({
        url: "./data/Oxnehaga-Area.geojson",
        renderer: {
          type: "simple",
          symbol: { type: "simple-fill", color: [0,100,255,0.25], outline: { color: [0,100,255], width: 2 } }
        },
        visible: true,
        popupEnabled: false
      });
      map.add(ox);

      const busIcon = "data:image/svg+xml;utf8," + encodeURIComponent(
        "<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64' viewBox='0 0 64 64'>"
        + "<rect x='10' y='8' width='44' height='38' rx='6' fill='#f59e0b'/>"
        + "<rect x='16' y='14' width='32' height='16' rx='3' fill='#e0f2fe'/>"
        + "<rect x='14' y='32' width='36' height='10' rx='3' fill='#1f2937' opacity='0.15'/>"
        + "<circle cx='20' cy='50' r='6' fill='#111827'/>"
        + "<circle cx='44' cy='50' r='6' fill='#111827'/>"
        + "<circle cx='20' cy='50' r='3' fill='#9ca3af'/>"
        + "<circle cx='44' cy='50' r='3' fill='#9ca3af'/>"
        + "<rect x='24' y='38' width='16' height='4' rx='2' fill='#0ea5e9'/>"
        + "</svg>"
      );

      const bus = new GeoJSONLayer({
        url: "./data/Busshallplaster_oxnehaga.geojson",
        elevationInfo: { mode: "relative-to-ground", offset: 1 },
        renderer: {
          type: "simple",
          symbol: {
            type: "picture-marker",
            url: busIcon,
            width: 18,
            height: 18
          }
        },
        visible: true,
        popupTemplate: {
          title: "Bussh√•llplats",
          content: [
            {
              type: "fields",
              fieldInfos: [
                { fieldName: "Nr", label: "Nr" },
                { fieldName: "Hplnamn", label: "Hplnamn" }
              ]
            }
          ]
        }
      });
      map.add(bus);

      const mark = new GeoJSONLayer({
        url: "./data/Komunal_mark.geojson",
        renderer: {
          type: "simple",
          symbol: {
            type: "simple-fill",
            color: [0, 160, 80, 0.35],
            outline: { color: [0, 120, 60], width: 1 }
          }
        },
        visible: true,
        popupEnabled: false
      });
      map.add(mark);

      const water = new GeoJSONLayer({
        url: "./data/Vatten_jonkoping_01.geojson",
        renderer: {
          type: "simple",
          symbol: {
            type: "simple-fill",
            color: [0, 150, 200, 0.4],
            outline: { color: [0, 120, 180], width: 1 }
          }
        },
        visible: true,
        popupEnabled: false
      });
      map.add(water);

      // Auto‚Äëzoom n√§r lagret √§r redo
      view.whenLayerView(ox).then(() => {
        ox.queryExtent().then((res) => {
          if (res && res.extent) {
            view.goTo({ target: res.extent, tilt: 38 }, { duration: 1200 });
          }
        });
      });

      // Switchar
      const swBuildings = document.getElementById("swBuildings");
      const swOx = document.getElementById("swOx");
      const swBus = document.getElementById("swBus");
      const swMark = document.getElementById("swMark");
      const swWater = document.getElementById("swWater");

      swBuildings.addEventListener("change", () => buildings.visible = swBuildings.checked);
      swOx.addEventListener("change", () => ox.visible = swOx.checked);
      swBus.addEventListener("change", () => bus.visible = swBus.checked);
      swMark.addEventListener("change", () => mark.visible = swMark.checked);
      swWater.addEventListener("change", () => water.visible = swWater.checked);

      // ===== Right panel: attribut + unika v√§rden =====
      const attrHint = document.getElementById("attrHint");
      const attrTable = document.getElementById("attrTable");
      const depHint = document.getElementById("depHint");
      const depList = document.getElementById("depList");
      const depMeta = document.getElementById("depMeta");
      const uniqueLayer = document.getElementById("uniqueLayer");
      const uniqueField = document.getElementById("uniqueField");
      const uniqueList = document.getElementById("uniqueList");
      const uniqueMeta = document.getElementById("uniqueMeta");
      const loadUnique = document.getElementById("loadUnique");

      const layerOptions = [
        { id: "buildings", title: "Byggnader", layer: buildings },
        { id: "ox", title: "Oxnehaga", layer: ox },
        { id: "bus", title: "Bussh√•llplatser", layer: bus },
        { id: "mark", title: "Kommunal mark", layer: mark },
        { id: "water", title: "Vatten", layer: water }
      ];

      function isFieldUsable(f) {
        if (!f) return false;
        const name = (f.name || "").toLowerCase();
        if (f.type === "oid" || f.type === "geometry") return false;
        if (name === "shape" || name === "shape_area" || name === "shape_length") return false;
        return true;
      }

      function fillLayerSelect() {
        uniqueLayer.innerHTML = "";
        layerOptions.forEach((opt) => {
          const el = document.createElement("option");
          el.value = opt.id;
          el.textContent = opt.title;
          uniqueLayer.appendChild(el);
        });
      }

      function fillFieldSelect(layer) {
        uniqueField.innerHTML = "";
        const fields = (layer.fields || []).filter(isFieldUsable);
        fields.forEach((f) => {
          const el = document.createElement("option");
          el.value = f.name;
          el.textContent = f.alias || f.name;
          uniqueField.appendChild(el);
        });
        loadUnique.disabled = fields.length === 0;
      }

      function getLayerById(id) {
        return layerOptions.find((l) => l.id === id)?.layer || null;
      }

      let lastSelection = null;
      let lastHighlight = null;

      function clearHighlight() {
        if (lastHighlight && typeof lastHighlight.remove === "function") {
          lastHighlight.remove();
        }
        lastHighlight = null;
      }

      function clearDepartures(message) {
        depList.innerHTML = "";
        depMeta.textContent = "";
        depHint.textContent = message || "Klicka p√• en bussh√•llplats";
      }

      function renderAttributes(attrs) {
        attrTable.innerHTML = "";
        if (!attrs) return;
        const keys = Object.keys(attrs).filter((k) => attrs[k] !== null && attrs[k] !== "").sort();
        keys.forEach((key) => {
          const row = document.createElement("tr");
          row.innerHTML = `<td>${key}</td><td>${attrs[key]}</td>`;
          row.style.cursor = "pointer";
          row.title = "Klicka f√∂r att markera objektet p√• kartan";
          row.addEventListener("click", () => {
            if (!lastSelection) return;
            view.goTo({ target: lastSelection.graphic, zoom: 18 }, { duration: 800 });
            view.whenLayerView(lastSelection.layer).then((lv) => {
              clearHighlight();
              lastHighlight = lv.highlight(lastSelection.graphic);
            });
          });
          attrTable.appendChild(row);
        });
      }

      function normalizeStopLocation(stop) {
        if (!stop) return null;
        const id = stop.id || stop.ID || null;
        const extId = stop.extId || stop.extid || stop.ExtId || null;
        const name = stop.name || stop.Name || null;
        return { id, extId, name };
      }

      async function fetchStopByCoords(lat, lon, radius) {
        const url = "https://api.resrobot.se/v2.1/location.nearbystops"
          + "?originCoordLat=" + encodeURIComponent(lat)
          + "&originCoordLong=" + encodeURIComponent(lon)
          + "&maxNo=1&r=" + encodeURIComponent(radius)
          + "&format=json"
          + "&accessId=" + encodeURIComponent(RESROBOT_KEY);

        const res = await fetch(url);
        if (!res.ok) throw new Error("Stop lookup HTTP " + res.status);
        const data = await res.json();
        // v2.1 can return StopLocation directly or within stopLocationOrCoordLocation
        const direct = normalizeStopLocation(data?.StopLocation?.[0]);
        if (direct) return direct;
        const mixed = data?.stopLocationOrCoordLocation || data?.StopLocationOrCoordLocation || [];
        const first = mixed[0];
        const stop = normalizeStopLocation(first?.StopLocation || first?.stopLocation || first);
        return stop || null;
      }

      function isValidStopId(stop) {
        if (!stop) return false;
        if (stop.extId) return true;
        if (!stop.id) return false;
        return !String(stop.id).startsWith("A=");
      }

      async function findNearbyStop(lat, lon) {
        const radii = [20, 150, 400];
        for (const r of radii) {
          const stop = await fetchStopByCoords(lat, lon, r);
          if (isValidStopId(stop)) return stop;
        }
        return null;
      }

      function formatDeparture(dep) {
        const time = dep.rtTime || dep.time || "";
        const line = dep.transportNumber || dep.name || "";
        const dir = dep.direction || "";
        return `${time}  ${line} ‚Üí ${dir}`.trim();
      }

      async function loadDeparturesForStop(geom, name) {
        if (!RESROBOT_KEY) {
          clearDepartures("L√§gg in din ResRobot API‚Äënyckel i koden");
          return;
        }
        depHint.textContent = "H√§mtar avg√•ngar‚Ä¶";
        depList.innerHTML = "";
        depMeta.textContent = "";

        try {
          let stop = null;
          if (geom && geom.type === "point") {
            const lon = geom.longitude ?? geom.x ?? (geom.coordinates ? geom.coordinates[0] : null);
            const lat = geom.latitude ?? geom.y ?? (geom.coordinates ? geom.coordinates[1] : null);
            if (lat !== null && lon !== null) {
              stop = await findNearbyStop(lat, lon);
            }
          }
          if (!stop || !(stop.extId || stop.id)) {
            clearDepartures("Hittade ingen matchande h√•llplats");
            return;
          }

          const stopId = stop.extId || stop.id;
          const url = "https://api.resrobot.se/v2.1/departureBoard"
            + "?id=" + encodeURIComponent(stopId)
            + "&format=json"
            + "&duration=720"
            + "&maxJourneys=5"
            + "&accessId=" + encodeURIComponent(RESROBOT_KEY);

          const res = await fetch(url);
          let data = null;
          try { data = await res.json(); } catch (e) { /* ignore */ }
          if (!res.ok) {
            const code = data?.errorCode || "HTTP " + res.status;
            const text = data?.errorText || "Ok√§nt fel";
            throw new Error(`${code}: ${text}`);
          }
          const deps = (data?.DepartureBoard?.Departure || data?.Departure || []).slice(0, 5);

          if (deps.length === 0) {
            clearDepartures("Inga avg√•ngar just nu");
            depMeta.textContent = `H√•llplats‚ÄëID: ${stopId}`;
            return;
          }

          depHint.textContent = "";
          deps.forEach((d) => {
            const li = document.createElement("li");
            li.textContent = formatDeparture(d);
            depList.appendChild(li);
          });
          depMeta.textContent = `N√§sta 12 h ‚Ä¢ H√•llplats‚ÄëID: ${stopId}`;
        } catch (e) {
          clearDepartures("Kunde inte h√§mta avg√•ngar");
          depMeta.textContent = String(e && e.message ? e.message : e);
          console.warn("Departures error:", e);
        }
      }

      view.on("click", (event) => {
        view.hitTest(event).then((hit) => {
          const found = hit.results.find((r) => r.graphic);
          if (!found) return;
          if (found.graphic.layer !== bus) {
            attrHint.style.display = "block";
            attrHint.textContent = "Klicka p√• en bussh√•llplats f√∂r att se attribut";
            attrTable.innerHTML = "";
            lastSelection = null;
            clearHighlight();
            clearDepartures();
            return;
          }
          attrHint.style.display = "none";
          lastSelection = { graphic: found.graphic, layer: found.graphic.layer };
          clearHighlight();
          view.whenLayerView(lastSelection.layer).then((lv) => {
            lastHighlight = lv.highlight(lastSelection.graphic);
          });
          renderAttributes(found.graphic.attributes);
          loadDeparturesForStop(found.graphic.geometry, found.graphic.attributes?.Hplnamn || "");
        });
      });

      function formatWhereValue(field, value, layer) {
        const fld = (layer.fields || []).find((f) => f.name === field);
        const type = fld?.type || "";
        if (type === "string" || type === "date") {
          const safe = String(value).replace(/'/g, "''");
          return `'${safe}'`;
        }
        return String(value);
      }

      async function highlightByValue(layer, field, value) {
        try {
          const where = `${field} = ${formatWhereValue(field, value, layer)}`;
          const result = await layer.queryFeatures({
            where,
            outFields: [field],
            returnGeometry: true
          });

          if (!result.features || result.features.length === 0) return;
          const features = result.features;
          const first = features[0];
          const geomType = first?.geometry?.type || "";

          if (geomType === "point") {
            view.goTo({ target: first, zoom: 19 }, { duration: 900 });
          } else {
            view.goTo(features, { duration: 900 });
          }
          view.whenLayerView(layer).then((lv) => {
            clearHighlight();
            lastHighlight = lv.highlight(features);
          });
        } catch (e) {
          console.warn("Highlight by value error:", e);
        }
      }

      async function loadUniqueValues() {
        const layer = getLayerById(uniqueLayer.value);
        const field = uniqueField.value;
        if (!layer || !field) return;

        uniqueList.innerHTML = "";
        uniqueMeta.textContent = "Laddar‚Ä¶";

        try {
          const result = await layer.queryFeatures({
            where: "1=1",
            outFields: [field],
            returnDistinctValues: true,
            orderByFields: [field]
          });

          const values = (result.features || [])
            .map((f) => f.attributes?.[field])
            .filter((v) => v !== null && v !== undefined && v !== "");

          const max = 200;
          const sliced = values.slice(0, max);
          sliced.forEach((v) => {
            const li = document.createElement("li");
            li.textContent = String(v);
            li.style.cursor = "pointer";
            li.title = "Klicka f√∂r att visa objekt p√• kartan";
            li.addEventListener("click", () => highlightByValue(layer, field, v));
            uniqueList.appendChild(li);
          });

          uniqueMeta.textContent = values.length
            ? `${values.length} unika v√§rden${values.length > max ? " (visar 200)" : ""}`
            : "Inga v√§rden";
        } catch (e) {
          uniqueMeta.textContent = "Kunde inte l√§sa unika v√§rden";
          console.warn("Unique values error:", e);
        }
      }

      // init unique panel
      fillLayerSelect();
      const firstLayer = getLayerById(uniqueLayer.value);
      if (firstLayer) {
        firstLayer.when(() => fillFieldSelect(firstLayer));
      }
      uniqueLayer.addEventListener("change", () => {
        const layer = getLayerById(uniqueLayer.value);
        if (layer) layer.when(() => fillFieldSelect(layer));
      });
      loadUnique.addEventListener("click", loadUniqueValues);
    });
  </script>
</body>
</html>
<<<<<<< HEAD




=======
>>>>>>> 6d43964 (Update UI, add layers and bus departures)
