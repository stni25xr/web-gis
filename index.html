<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="utf-8">
<title>STN25XR | Öxnehaga 4D GIS</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://js.arcgis.com/4.30/esri/themes/light/main.css">
<script src="https://js.arcgis.com/4.30/"></script>

<style>
html, body { margin:0; height:100%; font-family:Arial; }
#header {
  height:70px; background:#f4f4f4; border-bottom:2px solid #ccc;
  display:flex; justify-content:space-between; align-items:center; padding:0 20px;
}
#sidebar {
  position:absolute; top:70px; left:0; width:300px; bottom:0;
  background:#1e1e1e; color:white; padding:12px; overflow:auto; z-index:10;
}
#sceneView { position:absolute; top:70px; left:300px; right:0; bottom:0; }
table { width:100%; font-size:12px; border-collapse:collapse; }
td { border-bottom:1px solid #444; padding:4px; }
</style>
</head>

<body>

<div id="header">
  <b>STN25XR | Öxnehaga | 4D GIS</b>
  <div>
    <span id="temp">Temp: …</span> |
    <span id="clock">00:00:00</span>
  </div>
</div>

<div id="sidebar">
  <h3>Valt objekt</h3>
  <table id="attrTable"></table>
</div>

<div id="sceneView"></div>

<script>
setInterval(() =>
  clock.textContent = new Date().toLocaleTimeString("sv-SE"), 1000
);

fetch("https://api.open-meteo.com/v1/forecast?latitude=57.796&longitude=14.200&current=temperature_2m")
.then(r=>r.json()).then(d=>temp.textContent="Temp: "+d.current.temperature_2m+"°C");
</script>

<script>
require([
  "esri/Map","esri/views/SceneView",
  "esri/layers/GeoJSONLayer",
  "esri/widgets/LayerList","esri/widgets/Legend",
  "esri/widgets/TimeSlider"
], function(Map,SceneView,GeoJSONLayer,LayerList,Legend,TimeSlider){

const map = new Map({ basemap:"satellite", ground:"world-elevation" });

const view = new SceneView({
  container:"sceneView", map,
  camera:{ position:{latitude:57.796,longitude:14.200,z:1600}, tilt:45 }
});

/* ===== BYGGNADER (BIM) ===== */
const buildings = new GeoJSONLayer({
  url:"./data/Main_byggnad.geojson.json",
  elevationInfo:{ mode:"relative-to-ground" },
  renderer:{
    type:"simple",
    symbol:{
      type:"polygon-3d",
      symbolLayers:[{
        type:"extrude",
        size:{ field:"HEIGHT", value:10 },
        material:{ color:"#aaa" }
      }]
    }
  },
  popupTemplate:{ title:"Byggnad (BIM)", content:"{*}" },
  timeInfo:{
    startField:"START_DATE",
    endField:"END_DATE"
  }
});

/* ===== ÖVRIGA LAGER ===== */
const ox = new GeoJSONLayer({ url:"./data/Oxnehaga-Area.geojson" });
const bus = new GeoJSONLayer({ url:"./data/Busshallplaster_oxnehaga.geojson" });
const mark = new GeoJSONLayer({ url:"./data/Komunal_mark.geojson" });
const water = new GeoJSONLayer({ url:"./data/Vatten_jonkoping_01.geojson" });

map.addMany([ox,mark,water,buildings,bus]);

/* ===== WIDGETS ===== */
view.ui.add(new LayerList({ view }), "top-right");
view.ui.add(new Legend({ view }), "bottom-right");

const timeSlider = new TimeSlider({
  view,
  fullTimeExtent:{
    start:new Date("1990-01-01"),
    end:new Date("2035-12-31")
  }
});
view.ui.add(timeSlider,"bottom-left");

/* ===== ATTRIBUT-TABELL ===== */
view.on("click", e => {
  view.hitTest(e).then(r => {
    const g = r.results[0]?.graphic;
    if(!g) return;
    const tbl = document.getElementById("attrTable");
    tbl.innerHTML="";
    Object.entries(g.attributes).forEach(([k,v])=>{
      tbl.innerHTML += `<tr><td>${k}</td><td>${v}</td></tr>`;
    });
  });
});

});
</script>

</body>
</html>
